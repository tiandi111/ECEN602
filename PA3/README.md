SPRING2021_ECEN602_DI_TIAN
---

### Install and Usage
First, cd to the project root path:
```
cd /project/root/path/
```
Second, make binaries:
```
mkdir bin
make
```
To start TFTP server, run:
```
./bin/server <PORT> # e.g, ./bin/server 69
```
To run tests:
```
./bin/test                   # unit test
sh test/intergration_test.sh # integration test
```

### Compilation Options
Make options:
```
make server # make server binary
make test   # make unit test binray
make clean  # clean the intermidiate files generated by make
```
Or you can make them all-in-once use:
```
make
```
Note: there're some warnings generated by make, this is expected and can be ignored.

### Design and Architecture

---
#### Design goals
This project aims to implement the TFTP Protocol which consists of three major components:
- TFTP Poll Server (for efficiency reason, we use poll() instead of select())
- TFTP Session library
- File Reader library, includes readers for "netasicc" and "octet"

#### Extra design goals
An extra design goal is to make the code as reusable as possible. Hence, the tftp request
handling logic is decoupled from the tftp server by making an independent "TFTP Session library".

Users can use the "TFTP Session library" in whatever ways they what, e.g., select(), poll() and
epoll() can be used to implement the server. In this project, we use poll() to implement our
server.

--- 
#### Architecture
The development follows object-oriented programming. We created the following classes:

- TFTP Poll Server

    The TFTP server that implements I/0 Multiplexing by using poll() system call. Also, creating
    a child process for each incoming request is inefficient. Hence, we implement a stateful TFTP
    Session library that enables us to multiplex multiple request sessions within a single process.

- TFTP Session library 

    A stateful TFTP Session library that enables users to adopt different programming paradigms, e.g.,
    users can either adopt I/O multiplexing or multi-threading. 
    
    The library provides two kind of sessions: daemon session and request session. Daemon session
    is used to accept and create request sessions while request session is a stateful, self-contained
    session to handle TFTP requests.
    
    Once a TFTP request is created, users simply call Proceeds() method on the request session object
    repeatedly until it terminates or error occurred.
    
    An example:
    ```c++
        // create a daemon session
        ServerConfig serverConfig = {"0.0.0.0", 69, 10};
        TFTP::Session::DaemonSession daemonSession(serverConfig.addr, serverConfig.port, serverConfig.backlog);
        
        // accept a new request 
        auto req = daemonSession.AcceptRequest(serverConfig.timeout); 
        if (req) {
  
            // proceeds the session until it terminates
            do {
                try {
  
                    bool ReadReady = true; // try send data packet in next Proceeds() call
                    bool WriteReady = true; // try receive packet in next Proceeds() call
  
                    req->Proceeds(ReadReady, WriteReady);
  
                } catch (std::exception& e) { // terminates the req session if error occurred
  
                    ERROR(req->ID(), std::string("Proceeds: ") + e.what());
                    req->Terminate();
                }
  
            } while ( !req->Terminated() );
        }
    ```
    
- File Reader library

The system run as following:
```
              TFTP Client Requests
                 ↓  ↓  ↓  ↓  ↓
               +----------------+         
               |TFTP Poll Server|         
               +----------------+  
                       Λ
                    1. |
                  +--------+
                  | poll() | 
                  +--------+      
                  2.|     |3.
                    V     V
             +--------------------+ 
             |TFTP Session Library|
             +--------------------+
                Λ               Λ    
              4.|               | 5.
                V               V   
        +-------------+  +--------------+
        | File Readers|  | system calls |
        +-------------+  +--------------+
```
Explanation of the indexed arrows:
- Arrow 1

    The TFTP Poll Server registered all sessions' socket file descriptor within a pollfd struct array.
    Then an endless while loop is conducted to multiplex sessions with poll() system call.
    
- Arrow 2

    This arrow represents daemon session. The server accepts and creates tftp request sessions using
    daemon sessions.
  
- Arrow 3

    This arrow represents request sessions. The server handle tftp request logic using request sessions.

- Arrow 4

    The RRQ request sessions create file readers according to file transfer mode(either "netasicc"
    or "octet"). Then read data from files is simply call Read() method on the reader instance.
    
- Arrow 5

    The request sessions use sendto() and recvfrom() system calls to send and receive UDP packets.

### Contribution
All by Di Tian.
    

